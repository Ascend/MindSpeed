# 内存碎片优化

## 问题分析

在模型训练的过程中，需要大量的显存来存储模型参数、中间计算结果、优化器状态以及批量输入数据等。频繁地申请和释放内存空间容易引发内存碎片问题。<br />

## 解决方案

通过对不同生命周期的tensor进行分别管理，以减少内存碎片。

### 解决思路:

#### **识别不同生命周期的tensor**

   一次训练过程中，长生命周期的tensor主要有四种：  
   （1）模型初始化创建的权重、梯度等。  
   （2）在前向时产生的激活值。  
   （3）用户没有进行垃圾回收的tensor会保留到下一个step。  
   （4）梯度收敛后产生的优化器状态tensor。  

####  **使用不同的内存池隔离管理**
   （1）将识别出的长短生命周期tensor放入不同的内存池分别管理。  
   （2）对长生命周期的大tensor精准分配与tensor大小相同的block，并采取优化后的多级分配策略，以避免长生命周期tensor对应的内存池产生碎片。<br />

## 使用场景

## 使用方法
设置环境变量'MEMORY_FRAGMENTATION = 1'，即开启内存碎片优化特性。

## 使用效果
主要收益场景：llama2-7B、13B、70B <br />