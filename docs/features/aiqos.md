# AI QoS差异化调度特性说明
## 1技术背景
&#12288;&#12288;面向AI大模型训练，普遍采用混合并行方式进行分布式训练，以MoE大模型为例，采用TP（张量并行）、EP（专家并行）、DP（数据并行）、PP（流水线并行）的混合并行策略。并行策略的流量在超节点内通过UB网络进行NPU与NPU之间的（D2D）通信。
在不同的模型切分以及模型配置下，超节点内存在不同类型的流量冲突，包括D2D（如TP、EP）流量之间，以及H2D流量（如Swap）与D2D流量之间，如图1所示，在UB Switch处，会产生incast网络冲突，产生网络拥塞，影响整体通信性能。
![image](../../sources/images/aiqos1.png)
<div align="center">

图1 不同类型流量的流量冲突

</div>


&#12288;&#12288;由于不同流量对于算效发挥的贡献不同，某些通信流量可以通过上层相关机制实现较好的通算掩盖，如H2D的Swap流量或D2D的DP流量等，但某些流量难以掩盖或掩盖程度较低，因此可以针对不同类型流量进行差异化QoS调度，以实现算效最优的QoS映射。
不同类型流量产生冲突时，在UB Switch处，可以采用虚拟通道(VL)方式进行流量隔离，并在VL间进行差异化调度，实现：

1）不同类型流量间的VL隔离，避免拥塞扩散     

2）不同流量间的差异化调度。

![image](../../sources/images/aiqos2.png)

<div align="center">
图2 一种典型的QoS调度方式——SP调度
</div>

&#12288;&#12288;如图2所示，将不同类型流量映射至不同的VL，实现流量隔离的目的，并设置不同VL的优先级，采用SP方式（Strict Priority）进行调度，则不同类型流量同时达到UB Switch时，会优先将高优先级VL调度排空后，再调度下一级队列，依此类推，以达到不同类型流量差异化调度的目的。
## 2方案介绍
&#12288;&#12288;结合以上背景，本特性提供一种AI QoS差异化调度方案，实现：    
&#12288;&#12288;1）不同类型的流量映射至不同VL；  
&#12288;&#12288;2）VL间进行差异化调度，从而实现提高整体算效的目的。   
&#12288;&#12288;特性提供两种类型使能方式：   
&#12288;&#12288;1）自动模式，AI QoS通过感知AI大模型训练的流量类型、通信域、通信量以及算效贡献等，设计了一种算效优先的优先级映射与调度算法，并实现不同类型流量冲突度最小的VL映射以及算效优先的差异化QoS调度   
&#12288;&#12288;2）手动模式，用户可手工指定不同类型并行策略的QoS优先级，AI QoS按照用户手工指定的优先级，经过多层传递与QoS语义映射，将任务级的QoS语义转换为UB协议QoS语义，在UB报文中设置QoS值，并映射至UB Switch的相应VL，在VL间进行差异化调度。手动模式支持Low/Middle/High三档位的QoS优先级。
方案整体架构如图3所示：

![image](../../sources/images/aiqos3.png)
<div align="center">
图3 AI QoS差异化调度方案架构
</div>

&#12288;&#12288;D2D流量以并行策略为粒度，在创建Group时向torch_npu进行QoS标记下发，并经过CANN传递至NPU，最终按报文格式封装至UB报文中。H2D流量仅支持按通道级粒度进行全局QoS优先级设置（不包含算子下发的H2D流量），暂不支持算子粒度H2D流量的QoS优先级设置
UB Switch已预置QoS模板，包括QoS值至VL的映射关系以及VL间的调度策略，且支持开放QoS配置模板，用户可通过配置模板人工指定QoS值至VL的映射关系以及VL间的调度策略
## 3使用方法
### 3.1自动模式：
&#12288;&#12288;训练脚本中添加：   
&#12288;&#12288;--aiqos&#12288;&#12288;# AI QoS特性开关      
&#12288;&#12288;--aiqos-mode auto&#12288;&#12288;# 配置AI QoS模式为自动模式      
&#12288;&#12288;自动模式当前支持TP PP DP EP CP典型并行策略
### 3.2手动模式：
&#12288;&#12288;训练脚本中添加：   
&#12288;&#12288;--aiqos&#12288;&#12288;#AI QoS特性开关   
&#12288;&#12288;--aiqos-mode manual&#12288;&#12288;&#12288;&#12288;# 配置AI QoS模式为手动模式   
&#12288;&#12288;--aiqos-schedule {tp:high,pp:middle,dp:low}  # 配置不同并行策略的QoS优先级   
&#12288;&#12288;如上例所示，TP优先级设置为高，PP优先级设置为中，DP优先级设置为低。   
&#12288;&#12288;手动模式当前支持dp、dp-cp、intra-dp-cp、inter-dp-cp、cp、mp、tp、pp、embd、pos-embd、tp-dp-cp、tp-dp、tp-cp、ep、ep-tp、tp-ep-mp、tp-ep-pp、ep-dp、hcp并行策略
## 4使用场景与版本配套
AI QoS特性支持Atlas 800T A3超节点服务器及Atlas 900 A3 SuperPoD集群，需以下软件版本配套：   
| 软件        | 配套版本                          |
| :---------- | :-------------------------------- |
| torch_npu   | 7.3.RC1*                          |
| CANN        | CANN 8.6*                         |
| UB Switch   | LingQu Computing Network 1.6.0*   |

*预计配套版本，具体版本待相关组件正式发布后进行更新